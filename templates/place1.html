<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地名详情 - 兰州地名学习</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
  <style>
    body { font-family: "Microsoft YaHei", "PingFang SC", sans-serif; background-color: #f8f9fa; }
    .navbar { background-color: #3a5a40; }
    .navbar-brand, .nav-link { color: white !important; }
    .place-header { background-color: #a3b18a; color: white; padding: 2rem 0; margin-bottom: 2rem; }
    .character-item {
      display: inline-block;
      width: 80px;
      height: 80px;
      margin: 10px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      line-height: 80px;
      font-size: 2.5rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .character-item:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .semantic-network { 
      width: 100%; 
      height: 400px; 
      margin-bottom: 2rem; 
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .related-place-item {
      display: block;
      padding: 10px 15px;
      margin-bottom: 10px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-decoration: none;
      color: #333;
      transition: all 0.3s;
    }
    .related-place-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .section-title {
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #a3b18a;
      color: #3a5a40;
    }
    .loading-indicator {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error-message {
      color: #dc3545;
      padding: 10px;
      background-color: #f8d7da;
      border-radius: 4px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- 导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">兰州地名学习</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">地名网络</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="characters.html">汉字学习</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about.html">关于项目</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 地名标题 -->
  <header class="place-header">
    <div class="container text-center">
      <h1 id="place-name" class="display-4">地名加载中...</h1>
      <p id="place-pinyin" class="lead">拼音加载中...</p>
    </div>
  </header>

  <div class="container mb-5">
    <!-- 错误信息显示区域 -->
    <div id="error-container" class="mb-4" style="display: none;"></div>
    
    <!-- 地名汉字列表 -->
    <section class="characters-container">
      <h2 class="section-title">包含汉字</h2>
      <div id="characters-list" class="d-flex flex-wrap justify-content-center">
        <div class="loading-indicator">加载中...</div>
      </div>
    </section>

    <!-- 语义网络可视化 -->
    <section>
      <h2 class="section-title">语义网络</h2>
      <div id="semantic-network" class="semantic-network">
        <div class="loading-indicator">加载中...</div>
      </div>
    </section>

    <div class="row">
      <!-- 地名详情 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-body">
            <h2 class="card-title mb-4">地名详情</h2>
            <div class="detail-item mb-3">
              <span class="detail-label fw-bold">中心性：</span>
              <span id="place-centrality">加载中...</span>
            </div>
            <div class="detail-item">
              <span class="detail-label fw-bold">描述：</span>
              <p id="place-description">加载中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 相关地名 -->
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-body">
            <h2 class="card-title mb-4">关联地名</h2>
            <div id="related-places" class="related-places">
              <div class="loading-indicator">加载中...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const placeName = urlParams.get('name');

    let placeData = {};
    let networkData = {};
    let placeDataLoaded = false;
    let networkDataLoaded = false;

    // 显示错误信息
    function showError(message) {
      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      errorContainer.style.display = 'block';
      console.error(message);
    }

    // 加载数据文件
    fetch('place_data.json')
      .then(response => {
        if (!response.ok) {
          throw new Error(`无法加载 place_data.json: ${response.status} ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        placeData = data;
        placeDataLoaded = true;
        console.log('place_data.json 加载成功', Object.keys(data).length, '个地名');
        tryRender();
      })
      .catch(error => {
        showError(`加载地名数据失败: ${error.message}`);
        placeDataLoaded = true; // 即使失败也标记为已加载，以便继续渲染
        tryRender();
      });

    fetch('place_network_top100.json')
      .then(response => {
        if (!response.ok) {
          throw new Error(`无法加载 place_network_top100.json: ${response.status} ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        networkData = data;
        networkDataLoaded = true;
        console.log('place_network_top100.json 加载成功', data.nodes?.length || 0, '个节点');
        tryRender();
      })
      .catch(error => {
        showError(`加载网络数据失败: ${error.message}`);
        networkDataLoaded = true; // 即使失败也标记为已加载，以便继续渲染
        tryRender();
      });

    function tryRender() {
      if (!placeDataLoaded || !networkDataLoaded) return;
      
      if (!placeName) {
        document.getElementById('place-name').textContent = '未找到地名';
        showError('URL 参数中未指定地名，请在 URL 中添加 ?name=地名');
        return;
      }

      console.log(`开始渲染地名: ${placeName}`);
      
      // 检查数据中是否存在该地名
      const placeExists = placeData[placeName] || networkData.nodes?.some(node => node.name === placeName);
      if (!placeExists) {
        document.getElementById('place-name').textContent = placeName;
        showError(`未找到地名 "${placeName}" 的相关数据`);
      }

      renderPlaceDetails(placeName);
      renderCharacters(placeName);
      renderSemanticNetwork(placeName);
      renderRelatedPlaces(placeName);
    }

    // 渲染地名详情，优先 networkData，没有则查 placeData
    function renderPlaceDetails(name) {
      document.getElementById('place-name').textContent = name;
      
      // 获取拼音
      document.getElementById('place-pinyin').textContent = placeData[name]?.pinyin || '';
      
      // 获取中心性
      let centrality;
      let centralitySource = '';
      
      // 先从 networkData 中查找
      const node = networkData.nodes?.find(n => n.name === name);
      if (node && typeof node.centrality === 'number') {
        centrality = node.centrality;
        centralitySource = 'networkData';
      } 
      // 如果没有找到，再从 placeData 中查找
      else if (placeData[name] && typeof placeData[name].centrality === 'number') {
        centrality = placeData[name].centrality;
        centralitySource = 'placeData';
      }
      
      document.getElementById('place-centrality').textContent = 
        (typeof centrality === 'number') ? centrality.toFixed(2) : '未知';
      
      // 获取描述信息
      let description;
      let descriptionSource = '';
      
      // 先从 networkData 中查找
      if (node && node.description) {
        description = node.description;
        descriptionSource = 'networkData';
      } 
      // 如果没有找到，再从 placeData 中查找
      else if (placeData[name] && placeData[name].description) {
        description = placeData[name].description;
        descriptionSource = 'placeData';
      }
      
      // 调试信息
      console.log({
        地名: name,
        中心性: { 值: centrality, 来源: centralitySource },
        描述: { 值: description, 来源: descriptionSource },
        networkData节点: node,
        placeData节点: placeData[name]
      });
      
      document.getElementById('place-description').textContent = description || '暂无描述';
    }

    // 渲染包含的汉字
    function renderCharacters(name) {
      const charactersContainer = document.getElementById('characters-list');
      charactersContainer.innerHTML = '';
      
      if (!name) {
        charactersContainer.innerHTML = '<p>无法获取地名</p>';
        return;
      }
      
      const characters = name.split('');
      characters.forEach(char => {
        const charItem = document.createElement('div');
        charItem.className = 'character-item';
        charItem.textContent = char;
        charItem.onclick = function() {
          window.location.href = `character.html?char=${char}`;
        };
        charactersContainer.appendChild(charItem);
      });
    }

    // 渲染语义网络
    function renderSemanticNetwork(name) {
      const container = document.getElementById('semantic-network');
      
      if (!networkData.nodes || !networkData.links) {
        container.innerHTML = '<p class="p-3 text-center">无法加载网络数据</p>';
        return;
      }
      
      const chart = echarts.init(container);
      const relatedNodes = [];
      const relatedLinks = [];
      const currentNode = networkData.nodes.find(node => node.name === name);
      
      if (!currentNode) {
        container.innerHTML = `<p class="p-3 text-center">在网络数据中未找到 "${name}" 节点</p>`;
        return;
      }
      
      relatedNodes.push({
        ...currentNode,
        symbolSize: 50,
        itemStyle: { color: '#3a5a40' }
      });
      
      const directLinks = networkData.links.filter(
        link => link.source === name || link.target === name
      );
      
      directLinks.sort((a, b) => {
        const valueA = (typeof a.value === 'number') ? a.value : (a.weight || 0);
        const valueB = (typeof b.value === 'number') ? b.value : (b.weight || 0);
        return valueB - valueA;
      });
      
      const top20Links = directLinks.slice(0, 20);

      top20Links.forEach(link => {
        relatedLinks.push(link);
        const otherNodeName = link.source === name ? link.target : link.source;
        const otherNode = networkData.nodes.find(node => node.name === otherNodeName);
        if (otherNode && !relatedNodes.some(node => node.name === otherNodeName)) {
          relatedNodes.push({
            ...otherNode,
            symbolSize: 30 + (otherNode.centrality || 0) * 20
          });
        }
      });

      const option = {
        title: {
          text: `"${name}"的语义网络`,
          left: 'center',
          top: 10,
          textStyle: { color: '#3a5a40' }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.dataType === 'node') {
              return `${params.data.name}<br>中心性: ${params.data.centrality?.toFixed(2) || '未知'}`;
            } else {
              const val = (typeof params.data.value === 'number' ? params.data.value : params.data.weight);
              return `${params.data.source} → ${params.data.target}<br>关联强度: ${typeof val === 'number' && !isNaN(val) ? val.toFixed(2) : '未知'}`;
            }
          }
        },
        series: [{
          type: 'graph',
          layout: 'force',
          data: relatedNodes,
          links: relatedLinks,
          categories: [
            { name: '景点名胜' },
            { name: '城区街道' },
            { name: '郊区县域' },
            { name: '其他地名' }
          ],
          roam: true,
          label: {
            show: true,
            position: 'right',
            formatter: '{b}'
          },
          force: {
            repulsion: 100,
            edgeLength: 100
          },
          emphasis: {
            focus: 'adjacency',
            lineStyle: { width: 5 }
          }
        }]
      };

      chart.setOption(option);
      window.addEventListener('resize', function() {
        chart.resize();
      });
    }

    // 渲染关联地名
    function renderRelatedPlaces(name) {
      const container = document.getElementById('related-places');
      container.innerHTML = '';
      
      if (!networkData.links) {
        container.innerHTML = '<p>无法加载网络数据</p>';
        return;
      }
      
      const relatedLinks = networkData.links.filter(
        link => link.source === name || link.target === name
      );
      
      if (relatedLinks.length === 0) {
        container.innerHTML = '<p>暂无关联地名数据</p>';
        return;
      }
      
      relatedLinks.sort((a, b) => {
        const valueA = (typeof a.value === 'number') ? a.value : (a.weight || 0);
        const valueB = (typeof b.value === 'number') ? b.value : (b.weight || 0);
        return valueB - valueA;
      });
      
      const top5Links = relatedLinks.slice(0, 5);

      top5Links.forEach(link => {
        const otherNodeName = link.source === name ? link.target : link.source;
        const strengthRaw = (typeof link.value === 'number' ? link.value : link.weight);
        const strength = (typeof strengthRaw === 'number' && !isNaN(strengthRaw))
          ? strengthRaw.toFixed(2)
          : '未知';
        const linkItem = document.createElement('a');
        linkItem.className = 'related-place-item';
        linkItem.href = `place.html?name=${otherNodeName}`;
        linkItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <strong>${otherNodeName}</strong>
            <span class="badge bg-secondary">关联度: ${strength}</span>
          </div>
        `;
        container.appendChild(linkItem);
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
