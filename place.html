<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地名详情 - 兰州地名学习</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
  <style>
    body { font-family: "Microsoft YaHei", "PingFang SC", sans-serif; background-color: #f8f9fa; }
    .navbar { background-color: #3a5a40; }
    .navbar-brand, .nav-link { color: white !important; }
    .place-header { background-color: #a3b18a; color: white; padding: 2rem 0; margin-bottom: 2rem; }
    .centrality-badge { font-size: 1.3rem; color: #e6e6e6; margin-left: 18px; font-weight: normal; }
    .character-item {
      display: inline-block;
      width: 80px;
      height: 80px;
      margin: 10px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      line-height: 80px;
      font-size: 2.5rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .character-item:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .section-title {
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #a3b18a;
      color: #3a5a40;
    }
    .semantic-network { 
      width: 100%; 
      height: 400px; 
      margin-bottom: 2rem; 
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .related-place-item {
      display: block;
      padding: 10px 15px;
      margin-bottom: 10px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-decoration: none;
      color: #333;
      transition: all 0.3s;
    }
    .related-place-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <!-- 导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">兰州地名学习</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">地名网络</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="characters.html">汉字学习</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about.html">关于项目</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>



  <!-- 地名标题 -->
  <header class="place-header">
  <div class="container text-center">
    <div style="display: inline-block;">
      <h1 id="place-name" class="display-4 mb-1">地名加载中...</h1>
      <p id="place-pinyin" class="lead mb-2">拼音加载中...</p>
      <span id="place-centrality" class="centrality-badge d-block"></span>
    </div>
  </div>
</header>


  <div class="container mb-5">
    <!-- 地名汉字列表 -->
    <section class="characters-container">
      <h2 class="section-title">包含汉字</h2>
      <div id="characters-list" class="d-flex flex-wrap justify-content-center">
        <!-- 汉字将在这里动态加载 -->
      </div>
    </section>

    <!-- 语义网络可视化 -->
    <section>
      <h2 class="section-title">语义网络</h2>
      <div id="semantic-network" class="semantic-network"></div>
    </section>

    <!-- 相关地名 -->
    <section>
      <h2 class="section-title">关联地名</h2>
      <div id="related-places" class="related-places">
        <!-- 相关地名将在这里动态加载 -->
      </div>
    </section>
  </div>

  <script>
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const placeName = urlParams.get('name');
    
    let placeData = {};
    let networkData = {};
    
    // 加载地名数据
    fetch('./static/place_data.json')
      .then(response => response.json())
      .then(data => {
        placeData = data;
        if (placeName && placeData[placeName]) {
          renderPlaceDetails(placeName, placeData[placeName]);
          renderCharacters(placeName);
        } else {
          document.getElementById('place-name').textContent = '未找到地名';
        }
      });

    // 加载网络数据
    fetch('./static/place_network_top100.json')
      .then(response => response.json())
      .then(data => {
        networkData = data;
        if (placeName) {
          renderSemanticNetwork(placeName, networkData);
          renderRelatedPlaces(placeName, networkData);
        }
      });
    
    // 渲染地名信息（顶部）
    function renderPlaceDetails(name, data) {
      document.getElementById('place-name').textContent = name;
      document.getElementById('place-pinyin').textContent = data.pinyin || '';
      document.getElementById('place-centrality').textContent = 
        data.centrality ? `（中心性 ${data.centrality.toFixed(2)}）` : '（中心性未知）';
    }
    
    // 渲染包含的汉字
    async function renderCharacters(name) {
      const charactersContainer = document.getElementById('characters-list');
      charactersContainer.innerHTML = '';
      
      // 强制拆分所有字符，确保每个汉字都显示
      const characters = [];
      for (const char of name) {
        if (char.trim() !== '') {
          characters.push(char);
        }
      }
      
      // 调试日志（完成后可删除）
      console.log('处理地名:', name, '拆分结果:', characters);

      // 加载汉字数据
      let charData = {};
      try {
        const res = await fetch('static/character_detail.json');
        charData = await res.json();
      } catch (e) {
        console.error('加载汉字数据失败:', e);
      }

      characters.forEach(char => {
        // 创建卡片容器
        const cardContainer = document.createElement('div');
        cardContainer.style.textAlign = 'center';
        cardContainer.style.margin = '10px';
        
        // 拼音显示（卡片上方）
        if (charData[char]?.pinyin) {
          const pinyinDiv = document.createElement('div');
          pinyinDiv.textContent = charData[char].pinyin;
          pinyinDiv.style.fontSize = '0.9rem';
          pinyinDiv.style.color = '#666';
          pinyinDiv.style.marginBottom = '8px';
          cardContainer.appendChild(pinyinDiv);
        }
        
        // 汉字卡片
        const charItem = document.createElement('div');
        charItem.className = 'character-item';
        charItem.textContent = char;
        charItem.style.display = 'flex';
        charItem.style.justifyContent = 'center';
        charItem.style.alignItems = 'center';
        cardContainer.appendChild(charItem);
        
        // 点击事件
        charItem.onclick = function() {
          window.location.href = `character.html?char=${char}`;
        };
        charactersContainer.appendChild(cardContainer);
        
        charItem.appendChild(innerDiv);
        charItem.onclick = function() {
          window.location.href = `character.html?char=${char}`;
        };
        charactersContainer.appendChild(charItem);
      });
    }
    
    // 渲染语义网络
    function renderSemanticNetwork(name, networkData) {
      const chart = echarts.init(document.getElementById('semantic-network'));
      const relatedNodes = [];
      const relatedLinks = [];
      const currentNode = networkData.nodes.find(node => node.name === name);
      if (!currentNode) return;
      relatedNodes.push({
        ...currentNode,
        symbolSize: 50,
        itemStyle: { color: '#3a5a40' }
      });
      const directLinks = networkData.links.filter(
        link => link.source === name || link.target === name
      );
      directLinks.sort((a, b) => {
        // 兼容 weight/value 字段
        const va = (a.value !== undefined ? a.value : a.weight) || 0;
        const vb = (b.value !== undefined ? b.value : b.weight) || 0;
        return vb - va;
      });
      const top20Links = directLinks.slice(0, 20);
      top20Links.forEach(link => {
        // 兼容 weight/value 字段
        relatedLinks.push({
          ...link,
          value: link.value !== undefined ? link.value : link.weight
        });
        const otherNodeName = link.source === name ? link.target : link.source;
        const otherNode = networkData.nodes.find(node => node.name === otherNodeName);
        if (otherNode && !relatedNodes.some(node => node.name === otherNodeName)) {
          relatedNodes.push({
            ...otherNode,
            symbolSize: 30 + otherNode.centrality * 20
          });
        }
      });
      const option = {
        title: {
          text: `"${name}"的语义网络`,
          left: 'center',
          top: 10,
          textStyle: { color: '#3a5a40' }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.dataType === 'node') {
              return `${params.data.name}<br>中心性: ${params.data.centrality?.toFixed(2) || '未知'}`;
            } else {
              // 兼容 weight/value 字段
              const v = params.data.value !== undefined ? params.data.value : params.data.weight;
              return `${params.data.source} → ${params.data.target}<br>关联强度: ${v !== undefined ? (v.toFixed ? v.toFixed(2) : v) : '未知'}`;
            }
          }
        },
        legend: {
          data: ['景点名胜', '城区街道', '郊区县域', '其他地名'],
          bottom: 10
        },
        series: [{
          type: 'graph',
          layout: 'force',
          data: relatedNodes,
          links: relatedLinks,
          categories: [
            { name: '景点名胜' },
            { name: '城区街道' },
            { name: '郊区县域' },
            { name: '其他地名' }
          ],
          roam: true,
          label: {
            show: true,
            position: 'right',
            formatter: '{b}'
          },
          force: {
            repulsion: 100,
            edgeLength: 100
          },
          emphasis: {
            focus: 'adjacency',
            lineStyle: { width: 5 }
          }
        }]
      };
      chart.setOption(option);
      window.addEventListener('resize', function() {
        chart.resize();
      });
    }
    
    // 渲染关联地名（兼容weight和value字段）
    function renderRelatedPlaces(name, networkData) {
      const container = document.getElementById('related-places');
      container.innerHTML = '';
      const relatedLinks = networkData.links.filter(
        link => link.source === name || link.target === name
      );
      relatedLinks.sort((a, b) => {
        const va = (a.value !== undefined ? a.value : a.weight) || 0;
        const vb = (b.value !== undefined ? b.value : b.weight) || 0;
        return vb - va;
      });
      const top5Links = relatedLinks.slice(0, 5);
      if (top5Links.length === 0) {
        container.innerHTML = '<p>暂无关联地名数据</p>';
        return;
      }
      top5Links.forEach(link => {
        const otherNodeName = link.source === name ? link.target : link.source;
        const linkItem = document.createElement('a');
        linkItem.className = 'related-place-item';
        linkItem.href = `place.html?name=${otherNodeName}`;
        // 兼容 weight 和 value 字段
        const strengthRaw = link.value !== undefined ? link.value : link.weight;
        const strengthNum = Number(strengthRaw);
        const strength = (!isNaN(strengthNum) && strengthRaw !== null && strengthRaw !== undefined)
          ? Math.round(strengthNum * 100) / 100
          : '未知';
        linkItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <strong>${otherNodeName}</strong>
            <span class="badge bg-secondary">关联度: ${strength}</span>
          </div>
        `;
        container.appendChild(linkItem);
      });
    }
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
